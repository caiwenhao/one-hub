---
title: "视频生成"
description: "使用 Veo 系列模型进行视频生成与任务查询。"
openapi: 'POST /gemini/v1beta/models/{model}:predictLongRunning'
---

`POST /gemini/v1beta/models/{model}:predictLongRunning` 用于创建视频生成任务，支持文生视频、图生视频等多种模式。

## 创建视频任务

```bash
curl -X POST "$BASE_URL/gemini/v1beta/models/veo-2.0:predictLongRunning" \
  -H "x-goog-api-key: $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "prompt": "a drone rises from a beach at sunset, cinematic, 8s"
    },
    "config": {
      "durationSeconds": 8,
      "aspectRatio": "16:9"
    }
  }'
```

## 响应示例

```json
{
  "name": "operations/abc123xyz",
  "done": false
}
```

返回的 `name` 字段是任务 ID，用于后续查询任务状态。

## 查询任务状态

使用 `GET /gemini/v1beta/operations/{operation_id}` 查询任务进度：

```bash
curl "$BASE_URL/gemini/v1beta/operations/abc123xyz?model=veo-2.0" \
  -H "x-goog-api-key: $TOKEN"
```

<Note>
  `model` 参数用于选择渠道，建议与创建任务时使用的模型保持一致。
</Note>

## 任务完成响应

当 `done` 为 `true` 时，表示任务已完成：

```json
{
  "name": "operations/abc123xyz",
  "done": true,
  "response": {
    "generateVideoResponse": {
      "generatedSamples": [
        {
          "video": {
            "uri": "https://models.kapon.cloud/proxy/video/abc123xyz"
          },
          "metadata": {
            "durationSeconds": 8,
            "size": "1920x1080"
          }
        }
      ]
    }
  }
}
```

## 下载视频

从响应中获取视频 URL 后，可以直接下载：

```bash
curl -L "https://models.kapon.cloud/proxy/video/abc123xyz" \
  --output video.mp4
```

<Callout type="info">
  kapon 会自动代理视频 URL，确保下载链接的稳定性和安全性。
</Callout>

## 宽高比设置

通过 `aspectRatio` 参数控制视频比例：

```json
{
  "input": {
    "prompt": "city traffic time-lapse"
  },
  "config": {
    "durationSeconds": 8,
    "aspectRatio": "9:16"
  }
}
```

支持的宽高比：

- `16:9`：横向宽屏（1920x1080）
- `9:16`：竖向（1080x1920）
- `1:1`：正方形（1080x1080）

## 时长设置

通过 `durationSeconds` 参数设置视频时长：

```json
{
  "input": {
    "prompt": "ocean waves"
  },
  "config": {
    "durationSeconds": 4
  }
}
```

<Note>
  不同模型支持的时长范围不同，通常为 2-8 秒。具体限制请参考模型文档。
</Note>

## 图生视频

提供参考图像进行视频生成：

```json
{
  "input": {
    "prompt": "camera zooms in slowly",
    "image": {
      "bytesBase64Encoded": "<BASE64_IMAGE_DATA>"
    }
  },
  "config": {
    "durationSeconds": 8,
    "aspectRatio": "16:9"
  }
}
```

## 视频续写

基于已有视频进行续写：

```json
{
  "input": {
    "prompt": "continue the scene",
    "video": {
      "bytesBase64Encoded": "<BASE64_VIDEO_DATA>"
    }
  },
  "config": {
    "durationSeconds": 8
  }
}
```

## 轮询最佳实践

建议使用指数退避策略轮询任务状态：

```python
import time
import requests

def wait_for_video(operation_id, token, max_wait=300):
    base_url = "https://models.kapon.cloud"
    headers = {"x-goog-api-key": token}
    
    wait_time = 2
    elapsed = 0
    
    while elapsed < max_wait:
        url = f"{base_url}/gemini/v1beta/operations/{operation_id}?model=veo-2.0"
        resp = requests.get(url, headers=headers)
        data = resp.json()
        
        if data.get("done"):
            return data
        
        time.sleep(wait_time)
        elapsed += wait_time
        wait_time = min(wait_time * 1.5, 30)  # 最多等待30秒
    
    raise TimeoutError("Video generation timeout")
```

## OpenAI 兼容方式

也可以使用 OpenAI 风格的视频接口（如果你的渠道支持）：

```bash
curl -X POST "$BASE_URL/v1/videos" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "veo-2.0",
    "prompt": "sunset over mountains",
    "duration": 8,
    "size": "1920x1080"
  }'
```

## 计费说明

视频生成按时长计费：

- 计费单位：秒
- 计费时机：任务完成时
- kapon 会自动从响应中提取视频时长进行计费

<Callout type="tip">
  如果响应中无法解析时长，可以在查询时添加 `?duration=8` 参数明确指定计费时长。
</Callout>

## 常见参数

- `prompt`：视频描述文本（必填）
- `durationSeconds`：视频时长（秒）
- `aspectRatio`：宽高比（16:9、9:16、1:1）
- `image`：参考图像（图生视频）
- `video`：参考视频（视频续写）
