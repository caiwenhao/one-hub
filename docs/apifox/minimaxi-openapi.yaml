openapi: 3.0.3
info:
  title: One Hub - minimaxi 渠道 API
  version: 1.0.0
  description: |
    One Hub 提供的 minimaxi 渠道代理接口（OpenAI 兼容 + 视频官方路径）。
    - 认证：使用 One Hub 的用户 Token（非 minimaxi 平台 Key）
    - 域名：导入后可在 Apifox 环境中替换为你的 One Hub 地址

servers:
  - url: https://onehub.example.com
    description: 你的 One Hub 服务地址（导入后可在 Apifox 环境改成实际值）

security:
  - bearerAuth: []

paths:
  /minimaxi/v1/video_generation:
    post:
      summary: minimaxi 文/图/主体/首尾帧视频生成
      description: |
        与官方 `POST /v1/video_generation` 一致，动作将根据请求体自动识别：
        - 文生视频：提供 `prompt`
        - 图生视频：提供 `first_frame_image`（可选 `prompt`）
        - 首尾帧视频：同时提供 `first_frame_image` 与 `last_frame_image`
        - 主体参考视频：提供 `subject_reference`（当前仅支持模型 S2V-01）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MiniMaxVideoCreateRequest'
            examples:
              text2video:
                summary: 文生视频示例
                value:
                  model: MiniMax-Hailuo-02
                  prompt: a cinematic drone shot over a sunset beach, UHD
                  resolution: 768P
                  duration: 6
              image2video:
                summary: 图生视频示例
                value:
                  model: MiniMax-Hailuo-02
                  first_frame_image: https://example.com/first.jpg
                  prompt: cinematic camera fly-through
                  resolution: 1080P
                  duration: 10
              startEnd2video:
                summary: 首尾帧视频示例
                value:
                  model: MiniMax-Hailuo-02
                  first_frame_image: https://example.com/first.jpg
                  last_frame_image: https://example.com/last.jpg
                  resolution: 768P
                  duration: 6
              subject2video:
                summary: 主体参考视频示例
                value:
                  model: S2V-01
                  prompt: 女生跑向镜头并挥手
                  subject_reference:
                    - type: character
                      image:
                        - https://example.com/reference.jpg
                  resolution: 720P
                  duration: 6
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxVideoCreateResponse'

  /minimaxi/v1/query/video_generation:
    get:
      summary: 查询 minimaxi 视频任务状态
      description: |
        与官方一致：仅需 `task_id`，无需 `channel_id`。平台会优先根据提交时写入的映射定位渠道。
        - 当上游为 PPInfra 时，系统已对响应体进行“官方字段对齐”与状态映射，返回体不包含 `extra/task/videos/images/audios` 等上游专有字段。
        - 若任务非本平台创建或不在当前分组/账号，可能查询不到；此时可联系管理员将对应 MiniMax Key 加入当前分组。
      parameters:
        - in: query
          name: task_id
          required: true
          schema:
            type: string
          description: 提交任务返回的 task_id
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxVideoQueryResponse'

  # 官方兼容别名（完全对齐 minimaxi 文档）
  /v1/video_generation:
    post:
      summary: 官方别名 - 创建 minimaxi 视频任务
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MiniMaxVideoCreateRequest'
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxVideoCreateResponse'

  /v1/query/video_generation:
    get:
      summary: 官方别名 - 查询 minimaxi 视频任务
      parameters:
        - in: query
          name: task_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxVideoQueryResponse'

  /v1/t2a_async_v2:
    post:
      summary: 官方别名 - 创建异步文本转语音任务
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MiniMaxAsyncSpeechRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxAsyncSpeechResponse'

  /v1/query/t2a_async_query_v2:
    get:
      summary: 官方别名 - 查询异步文本转语音任务
      parameters:
        - in: query
          name: task_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxAsyncSpeechQueryResponse'

  /minimaxi/v1/files/retrieve:
    get:
      summary: 获取文件下载信息（MiniMax 渠道）
      description: |
        根据 `file_id` 获取可用的下载链接。平台优先使用历史查询回填的映射定位渠道；
        首次命中后会自动建立映射，后续同一 `file_id` 可直接命中。
      parameters:
        - in: query
          name: file_id
          required: true
          schema:
            type: string
          description: 需要下载的文件 ID，通常来源于任务查询接口返回的 `file_id`
        - in: query
          name: channel_id
          required: false
          schema:
            type: integer
          description: 可选，强制指定渠道（排查/特殊路由使用）
        - in: query
          name: task_id
          required: false
          schema:
            type: string
          description: 可选，按任务反查渠道（兼容历史数据）
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxFileRetrieveResponse'

  /minimaxi/v1/files/retrieve_content:
    get:
      summary: 下载文件内容（MiniMax 渠道）
      description: 根据 `file_id` 直接下载视频或其它生成文件，可与 `/minimaxi/v1/files/retrieve` 返回的 `download_url` 联动使用。
      parameters:
        - in: query
          name: file_id
          required: true
          schema:
            type: string
          description: 需要下载的文件 ID
        - in: query
          name: channel_id
          required: false
          schema:
            type: integer
        - in: query
          name: task_id
          required: false
          schema:
            type: string
      responses:
        '200':
          description: 成功，返回二进制文件流
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /minimaxi/v1/t2a_v2:
    post:
      summary: minimaxi 官方 - 同步文本转语音
      description: |
        与官方 `POST /v1/t2a_v2` 一致。默认返回 JSON，其中 `data.audio` 为 hex 编码音频；
        当渠道启用 `audio_mode=hex` 时，One Hub 会将响应转换为真实音频流，并通过响应头暴露字幕与声道信息。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MiniMaxSpeechRequest'
            example:
              model: speech-2.5-hd-preview
              text: 你好，欢迎来到 One Hub
              stream: false
              voice_setting:
                voice_id: moss_audio_ce44fc67-7ce3-11f0-8de5-96e35d26fb85
                speed: 1
              audio_setting:
                format: mp3
                sample_rate: 32000
                channel: 1
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxSpeechResponse'
            audio/mpeg:
              schema:
                type: string
                format: binary
          headers:
            X-Minimax-Subtitle-URL:
              schema:
                type: string
                format: uri
              description: 若开启字幕服务且存在字幕文件，会返回下载地址
            X-Minimax-Audio-Channel:
              schema:
                type: string
              description: 若返回为音频流，指示音频声道数

  /minimaxi/v1/t2a_async_v2:
    post:
      summary: minimaxi 官方 - 创建异步文本转语音任务
      description: 与官方接口一致，支持 `text` 或 `text_file_id` 两种输入方式。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MiniMaxAsyncSpeechRequest'
            example:
              model: speech-2.5-hd-preview
              text: 真正的危险不是计算机像人一样思考，而是人像计算机一样思考。
              voice_setting:
                voice_id: moss_audio_ce44fc67-7ce3-11f0-8de5-96e35d26fb85
              audio_setting:
                format: mp3
                audio_sample_rate: 32000
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxAsyncSpeechResponse'

  /minimaxi/v1/query/t2a_async_query_v2:
    get:
      summary: minimaxi 官方 - 查询异步文本转语音任务
      description: 默认按当前 Token 分组遍历可用的 MiniMax 渠道；也可通过 `channel_id` 强制指定渠道。
      parameters:
        - in: query
          name: task_id
          required: true
          schema:
            type: string
          description: 创建任务时返回的 task_id
        - in: query
          name: channel_id
          required: false
          schema:
            type: integer
          description: 可选，强制指定渠道（调试或特殊路由使用）
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxAsyncSpeechQueryResponse'

  # OpenAI 兼容别名 - 文件接口（仅下载/检索，服务端已做官方字段对齐与上游差异吸收）
  /v1/files/retrieve:
    get:
      summary: 官方别名 - 获取文件下载信息
      parameters:
        - in: query
          name: file_id
          required: true
          schema:
            type: string
        - in: query
          name: channel_id
          schema:
            type: integer
        - in: query
          name: task_id
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MiniMaxFileRetrieveResponse'

  /v1/files/retrieve_content:
    get:
      summary: 官方别名 - 下载文件内容
      parameters:
        - in: query
          name: file_id
          required: true
          schema:
            type: string
        - in: query
          name: channel_id
          schema:
            type: integer
        - in: query
          name: task_id
          schema:
            type: string
      responses:
        '200':
          description: 成功，返回二进制文件流
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  # OpenAI 兼容 - 文本（minimaxi: MiniMax-M1 / MiniMax-Text-01）
  /v1/chat/completions:
    post:
      summary: OpenAI 兼容 - 文本生成（minimaxi）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatCompletionsRequest'
            example:
              model: MiniMax-M1
              messages:
                - role: system
                  content: 你是一个有帮助的助手
                - role: user
                  content: 你好，介绍一下你自己
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatCompletionsResponse'

  # OpenAI 兼容 - 语音（TTS）
  /v1/audio/speech:
    post:
      summary: OpenAI 兼容 - 文本转语音（minimaxi）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SpeechRequest'
            example:
              model: speech-02-turbo
              input: "你好，今天天气不错"
              voice: alloy
              speed: 1.0
              response_format: mp3-1-32000-128000
      responses:
        '200':
          description: 成功，返回音频
          content:
            audio/mpeg:
              schema:
                type: string
                format: binary

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    MiniMaxVideoCreateRequest:
      type: object
      properties:
        model:
          type: string
          description: 默认 MiniMax-Hailuo-02
          example: MiniMax-Hailuo-02
        prompt:
          type: string
          description: 文生/图生可选提示词
        first_frame_image:
          type: string
          format: uri
          description: 图生/首尾帧-首帧
        last_frame_image:
          type: string
          format: uri
          description: 首尾帧-尾帧
        reference_image:
          type: string
          format: uri
        subject_reference:
          type: array
          description: 主体参考配置，仅当模型为 S2V-01（subject2video）时可用，当前仅支持单主体
          items:
            $ref: '#/components/schemas/MiniMaxSubjectReference'
        duration:
          type: integer
          enum: [6, 10]
          description: 视频时长（Hailuo-02 常用 6/10 秒）
          example: 6
        resolution:
          type: string
          enum: [512P, 768P, 1080P]
          example: 768P
        callback_url:
          type: string
          format: uri
        enable_prompt_expansion:
          type: boolean
          description: 兼容字段，功能等价于 prompt_optimizer
        prompt_optimizer:
          type: boolean
          description: 是否自动优化 prompt（官方字段，默认 true）
        fast_pretreatment:
          type: boolean
          description: 是否缩短 prompt_optimizer 的优化耗时（仅 Hailuo-02 生效）
        aigc_watermark:
          type: boolean
          description: 是否在生成视频中添加水印
        external_task_id:
          type: string

    MiniMaxVideoCreateResponse:
      type: object
      properties:
        task_id:
          type: string
        base_resp:
          type: object
          properties:
            status_code:
              type: integer
            status_msg:
              type: string

    MiniMaxVideoQueryResponse:
      type: object
      properties:
        task_id:
          type: string
        status:
          type: string
          description: queueing/processing/success/failed（全部小写，与官方回调保持一致）
        file_id:
          type: string
        video_url:
          type: string
          format: uri
        cover_image:
          type: string
          format: uri
        watermarked_url:
          type: string
          format: uri
        video_width:
          type: integer
          description: 生成视频宽度，单位像素
        video_height:
          type: integer
          description: 生成视频高度，单位像素
        progress_percent:
          type: number
          format: float
        eta:
          type: integer
        error_code:
          type: string
        error_message:
          type: string
        base_resp:
          type: object
          properties:
            status_code:
              type: integer
            status_msg:
              type: string

    MiniMaxFileRetrieveResponse:
      type: object
      properties:
        file:
          $ref: '#/components/schemas/MiniMaxFileObject'
        base_resp:
          type: object
          properties:
            status_code:
              type: integer
            status_msg:
              type: string

    MiniMaxFileObject:
      type: object
      properties:
        file_id:
          type: string
          description: 文件 ID
        bytes:
          type: integer
          format: int64
        created_at:
          type: integer
          format: int64
          description: 文件创建时间的 Unix 时间戳（秒）
        filename:
          type: string
        purpose:
          type: string
        download_url:
          type: string
          format: uri

    MiniMaxSpeechRequest:
      type: object
      required:
        - model
        - text
      properties:
        model:
          type: string
          description: 请求的模型，例如 speech-2.5-hd-preview
        text:
          type: string
          description: 需要合成的文本
        stream:
          type: boolean
          description: 是否开启流式返回
        stream_options:
          $ref: '#/components/schemas/MiniMaxStreamOptions'
        voice_setting:
          $ref: '#/components/schemas/MiniMaxVoiceSetting'
        audio_setting:
          $ref: '#/components/schemas/MiniMaxAudioSetting'
        pronunciation_dict:
          $ref: '#/components/schemas/MiniMaxPronunciationDict'
        timber_weights:
          type: array
          items:
            $ref: '#/components/schemas/MiniMaxTimbreWeight'
        language_boost:
          type: string
          description: 语言增强配置
        voice_modify:
          $ref: '#/components/schemas/MiniMaxVoiceModify'
        subtitle_enable:
          type: boolean
        output_format:
          type: string
          enum: [url, hex]
          description: 默认 hex，设置为 url 时返回音频地址
        aigc_watermark:
          type: boolean

    MiniMaxStreamOptions:
      type: object
      properties:
        exclude_aggregated_audio:
          type: boolean

    MiniMaxVoiceSetting:
      type: object
      required:
        - voice_id
      properties:
        voice_id:
          type: string
        speed:
          type: number
        vol:
          type: number
        pitch:
          type: integer
        emotion:
          type: string
        text_normalization:
          type: boolean
        latex_read:
          type: boolean

    MiniMaxAudioSetting:
      type: object
      properties:
        sample_rate:
          type: integer
        bitrate:
          type: integer
        format:
          type: string
          enum: [mp3, pcm, flac, wav]
        channel:
          type: integer
        force_cbr:
          type: boolean

    MiniMaxPronunciationDict:
      type: object
      properties:
        tone:
          type: array
          items:
            type: string

    MiniMaxTimbreWeight:
      type: object
      properties:
        voice_id:
          type: string
        weight:
          type: integer

    MiniMaxVoiceModify:
      type: object
      properties:
        pitch:
          type: integer
        intensity:
          type: integer
        timbre:
          type: integer
        sound_effects:
          type: string

    MiniMaxSpeechResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            audio:
              type: string
              description: hex 编码音频或 `audio_mode=hex` 时的音频流在响应体中返回
            subtitle_file:
              type: string
              format: uri
            status:
              type: integer
        extra_info:
          type: object
          properties:
            audio_length:
              type: integer
              format: int64
            audio_sample_rate:
              type: integer
              format: int64
            audio_size:
              type: integer
              format: int64
            bitrate:
              type: integer
              format: int64
            audio_channel:
              type: integer
            audio_format:
              type: string
            usage_characters:
              type: integer
            invisible_character_ratio:
              type: number
        trace_id:
          type: string
        base_resp:
          type: object
          properties:
            status_code:
              type: integer
            status_msg:
              type: string

    MiniMaxAsyncSpeechRequest:
      type: object
      required:
        - model
      properties:
        model:
          type: string
        text:
          type: string
          description: "`text` 与 `text_file_id` 至少填写一个"
        text_file_id:
          type: string
          description: 通过文件上传接口获得的文本文件 ID
        voice_setting:
          $ref: '#/components/schemas/MiniMaxAsyncVoiceSetting'
        audio_setting:
          $ref: '#/components/schemas/MiniMaxAsyncAudioSetting'
        pronunciation_dict:
          $ref: '#/components/schemas/MiniMaxPronunciationDict'
        language_boost:
          type: string
        voice_modify:
          $ref: '#/components/schemas/MiniMaxVoiceModify'
        aigc_watermark:
          type: boolean
        timber_weights:
          type: array
          items:
            $ref: '#/components/schemas/MiniMaxTimbreWeight'
        subtitle_enable:
          type: boolean
        output_format:
          type: string
        stream:
          type: boolean
        stream_options:
          $ref: '#/components/schemas/MiniMaxStreamOptions'

    MiniMaxAsyncVoiceSetting:
      type: object
      required:
        - voice_id
      properties:
        voice_id:
          type: string
        speed:
          type: number
        vol:
          type: number
        pitch:
          type: integer
        emotion:
          type: string
        english_normalization:
          type: boolean

    MiniMaxAsyncAudioSetting:
      type: object
      properties:
        audio_sample_rate:
          type: integer
        bitrate:
          type: integer
        format:
          type: string
          enum: [mp3, pcm, flac]
        channel:
          type: integer

    MiniMaxAsyncSpeechResponse:
      type: object
      properties:
        task_id:
          type: string
        file_id:
          type: string
          description: 若未生成可为空字符串
        task_token:
          type: string
        usage_characters:
          type: integer
        trace_id:
          type: string
        base_resp:
          type: object
          properties:
            status_code:
              type: integer
            status_msg:
              type: string

    MiniMaxAsyncSpeechQueryResponse:
      type: object
      properties:
        task_id:
          type: string
        status:
          type: string
          description: success/failed/expired/processing
        file_id:
          type: string
          description: 若任务尚未生成文件，可为空字符串
        base_resp:
          type: object
          properties:
            status_code:
              type: integer
            status_msg:
              type: string

    MiniMaxSubjectReference:
      type: object
      properties:
        type:
          type: string
          description: 主体类型，目前仅支持 character
          example: character
        image:
          type: array
          description: 主体参考图列表，目前仅支持单张图片
          items:
            type: string
            format: uri

    ChatCompletionsRequest:
      type: object
      properties:
        model:
          type: string
          enum: [MiniMax-M1, MiniMax-Text-01]
        messages:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [system, user, assistant]
              content:
                type: string

    ChatCompletionsResponse:
      type: object
      properties:
        id:
          type: string
        object:
          type: string
          example: chat.completion
        model:
          type: string
        choices:
          type: array
          items:
            type: object
            properties:
              index:
                type: integer
              message:
                type: object
                properties:
                  role:
                    type: string
                  content:
                    type: string

    SpeechRequest:
      type: object
      properties:
        model:
          type: string
          enum: [
            speech-2.5-hd-preview, speech-02-hd, speech-01-hd,
            speech-2.5-turbo-preview, speech-02-turbo, speech-01-turbo
          ]
        input:
          type: string
        voice:
          type: string
          description: One Hub 会将 openai 声音映射到 minimaxi 音色
          example: alloy
        speed:
          type: number
          format: float
          example: 1.0
        response_format:
          type: string
          description: 例如 mp3-1-32000-128000
