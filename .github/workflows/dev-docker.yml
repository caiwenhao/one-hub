name: dev-docker

on:
  push:
    branches: [ "dev" ]
    paths:
      - VERSION

env:
  # 可选：在 GitHub Repo "Variables" 中设置 DOCKERHUB_NAMESPACE / DOCKERHUB_REPO 覆盖默认 owner/repo
  DOCKERHUB_NAMESPACE: ${{ vars.DOCKERHUB_NAMESPACE }}
  DOCKERHUB_REPO: ${{ vars.DOCKERHUB_REPO }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: ver
        run: |
          V=$(sed -n '1p' VERSION | tr -d ' \r\n')
          if [ -z "$V" ]; then echo "VERSION 为空，终止" && exit 1; fi
          echo "version=$V" >> $GITHUB_OUTPUT

      - name: Compute Docker Hub image name (lowercase)
        id: image
        run: |
          # 优先使用变量 DOCKERHUB_NAMESPACE，其次回退到 Secret: DOCKERHUB_USERNAME，最后用 GitHub 仓库 owner
          ns="${DOCKERHUB_NAMESPACE:-${{ secrets.DOCKERHUB_USERNAME }}}"
          if [ -z "$ns" ]; then ns="${GITHUB_REPOSITORY_OWNER}"; fi
          repo_only="${DOCKERHUB_REPO:-${GITHUB_REPOSITORY##*/}}"
          ns=$(echo "$ns" | tr '[:upper:]' '[:lower:]')
          repo_only=$(echo "$repo_only" | tr '[:upper:]' '[:lower:]')
          echo "name=$ns/$repo_only" >> $GITHUB_OUTPUT
          echo "Using Docker Hub image: $ns/$repo_only"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta (Docker Hub)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=raw,value=${{ steps.ver.outputs.version }}
            type=sha,format=short
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push (Docker Hub)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64
          build-args: |
            # 使用国内 npm 镜像缓解 yarn 安装超时（如无需求可删除本行改回官方源）
            NPM_REGISTRY=https://registry.npmmirror.com
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Summary
        run: |
          echo "Pushed image tags:" && echo "${{ steps.meta.outputs.tags }}" | tr ' ' '\n'
